---
- name: Consul install
  become: true
  become_user: consul
  vars:
    ip_address_list: ['192.168.121.11', '192.168.121.12', '192.168.121.14']
    bootstrap_expect: 3
    datacenter_name: demo
    data_dir: /var/lib/consul
    config_dir: /etc/consul.d


  block:
    - name: Genereting consul encrypt
      ansible.builtin.command: "consul keygen"
      changed_when: true
      register: key_content

    - name: Putting key to template
      ansible.builtin.template:
        src: templates/consul.conf.j2
        dest: /etc/consul.d/consul.hcl
        mode: "0755"
      vars:
        key_content: "key_content['stdout']"

    - name: Creating consul.service
      ansible.builtin.template:
        src: templates/consul.service.j2
        dest: /usr/lib/systemd/system/consul.service
        mode: "0755"

    - name: Reloading daemon
      ansible.builtin.systemd:
        state: restarted
        daemon_reload: true
        name: consul.service

